---
# Integration tests for replicate_existing_rds_instance
- name: Test 'test_replicate_existing_rds_instance' role
  module_defaults:
    group/aws:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      security_token: '{{ security_token | default(omit) }}'
      region: "{{ aws_region }}"

  block:
    # Define rds source instance and replica instance ====================================
    - name: Define rds instance name used for tests
      ansible.builtin.set_fact:
        rds_instance:
          src: "{{ instance_id }}-source"
          repli: "{{ instance_id }}-replica"

    # Create a source DB instance and replica instance ===================================
    - name: Create source DB instance
      amazon.aws.rds_instance:
        id: "{{ rds_instance.src }}"
        state: present
        engine: "{{ engine }}"
        db_instance_class: "{{ db_instance_class }}"
        username: "{{ username }}"
        password: "{{ password }}"
        allocated_storage: "{{ allocated_storage }}"
        max_allocated_storage: "{{ max_allocated_storage }}"
        skip_final_snapshot: true
      register: rds_instance_src

    - name: Check if source and replica DB instances are created
      ansible.builtin.assert:
        that:
        - rds_instance_src.changed
        - rds_instance_src.db_instance_identifier == "testrdsinstance-source"

    - name: Create a DB instance replica
      ansible.builtin.include_role:
        name: cloud.aws_ops.create_rds_replica_from_existing_rds_instance
      vars:
        replicate_existing_rds_instance_rds_instance_repli: "{{ rds_instance.repli }}"
        replicate_existing_rds_instance_rds_instance_src: "{{ rds_instance.src }}"

    - name: Get information about DB instance source
      amazon.aws.rds_instance_info:
        id: "{{ rds_instance.src }}"
      register: rds_instance_src

    - name: Get information about DB instance replica
      amazon.aws.rds_instance_info:
        id: "{{ rds_instance.repli }}"
      register: rds_instance_repli

    - name: Check if source and replica DB instances are created
      ansible.builtin.assert:
        that:
          - rds_instance_repli.instances[0].db_instance_identifier == "testrdsinstance-replica"
          - rds_instance_repli.instances[0].read_replica_source_db_instance_identifier == "testrdsinstance-source"
          - rds_instance_repli.instances[0].read_replica_db_instance_identifiers == []
          - rds_instance_src.instances[0].read_replica_db_instance_identifiers == ["testrdsinstance-replica"]


  always:
    # Clean up starts here =================================================================
    - name: Delete source DB instance
      amazon.aws.rds_instance:
        id: "{{ rds_instance.src }}"
        state: absent
        skip_final_snapshot: true
      ignore_errors: true

    - name: Delete a replica DB instance
      amazon.aws.rds_instance:
        id: "{{ rds_instance.repli }}"
        state: absent
        skip_final_snapshot: true
      ignore_errors: true
